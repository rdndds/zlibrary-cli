"""
Export functionality for Z-Library Search Application
"""
import json
import re
from typing import List
from zlibrary.book import Book
from zlibrary.logging_config import get_logger


class ExportManager:
    """Handles exporting book data to various formats"""

    def export_results_to_json(self, results: List[Book], filename: str = 'search_results.json'):
        """
        Export search results to a JSON file in human-readable format

        Args:
            results (list): List of Book objects
            filename (str): Output JSON filename
        """
        logger = get_logger(__name__)
        if not results:
            print(f"No results to export to {filename}")
            return

        # Create export directory if it doesn't exist
        import os
        export_dir = os.path.dirname(filename)
        if export_dir == '':
            # If no directory was specified in the filename, use 'export' directory
            export_dir = 'export'
            filename = os.path.join(export_dir, os.path.basename(filename))

        os.makedirs(export_dir, exist_ok=True)

        # Convert Book objects to dictionaries for JSON serialization
        results_data = []
        for book in results:
            # Create a dictionary with all available fields
            book_data = {
                'title': book.title,
                'author': book.author,
                'year': book.year,
                'file_type': book.file_type if book.file_type != 'Unknown' else book.format,
                'url': book.url,
                'publisher': book.publisher,
                'isbn': book.isbn,
                'language': book.language,
                'filesize': book.filesize,
                'format': book.format if book.format != 'Unknown' else book.file_type,
                'description': book.description,
                'download_url': book.download_url
            }
            results_data.append(book_data)

        with open(filename, 'w', encoding='utf-8') as jsonfile:
            json.dump(results_data, jsonfile, indent=2, ensure_ascii=False)

        print(f"Exported {len(results)} results to {filename}")

    def export_results_to_bibtex(self, results: List[Book], filename: str = 'search_results.bib'):
        """
        Export search results to a BibTeX file

        Args:
            results (list): List of Book objects
            filename (str): Output BibTeX filename
        """
        logger = get_logger(__name__)
        if not results:
            print(f"No results to export to {filename}")
            return

        # Create export directory if it doesn't exist
        import os
        export_dir = os.path.dirname(filename)
        if export_dir == '':
            # If no directory was specified in the filename, use 'export' directory
            export_dir = 'export'
            filename = os.path.join(export_dir, os.path.basename(filename))

        os.makedirs(export_dir, exist_ok=True)

        with open(filename, 'w', encoding='utf-8') as bibfile:
            bibfile.write('% BibTeX export from Z-Library Search\n')
            bibfile.write('% Generated by zlibrary_search.py\n\n')

            for i, book in enumerate(results, 1):
                # Clean title for BibTeX key
                clean_title = re.sub(r'[^a-zA-Z0-9]', '', book.get_clean_title()[:20]).lower()
                clean_author = re.sub(r'[^a-zA-Z0-9]', '', book.get_clean_author()[:10]).lower()[:5]
                key = f"{clean_author}{book.year if book.year != 'Unknown' else '0000'}{clean_title}"

                bibfile.write(f"@book{{{key},\n")
                bibfile.write(f"  title = {{{{{book.title}}}}},\n")
                bibfile.write(f"  author = {{{{{book.author}}}}},\n")
                if book.year and book.year != 'Unknown':
                    bibfile.write(f"  year = {{{book.year}}},\n")
                if book.publisher and book.publisher != 'Unknown':
                    bibfile.write(f"  publisher = {{{{{book.publisher}}}}},\n")
                if book.isbn and book.isbn != 'Unknown':
                    bibfile.write(f"  isbn = {{{book.isbn}}},\n")
                if book.language and book.language != 'Unknown':
                    bibfile.write(f"  language = {{{book.language}}},\n")
                if book.url:
                    bibfile.write(f"  url = {{{book.url}}},\n")
                if book.format and book.format != 'Unknown':
                    bibfile.write(f"  format = {{{book.format}}},\n")
                bibfile.write("}\n\n")

        print(f"Exported {len(results)} results to {filename}")

    def export_results(self, results: List[Book], filename_base: str, format_type: str = 'bibtex'):
        """
        Export search results in the specified format, defaulting to BibTeX

        Args:
            results (list): List of Book objects
            filename_base (str): Base name for the output file (without extension)
            format_type (str): Format to export ('json', 'bibtex', or 'both'). Defaults to 'bibtex'
        """
        logger = get_logger(__name__)
        if not results:
            print("No results to export")
            return

        # Determine which formats to export based on format_type
        formats_to_export = []
        if format_type == 'both':
            formats_to_export = ['json', 'bibtex']
        elif format_type in ['json', 'bibtex']:
            formats_to_export = [format_type]
        else:
            # Default to bibtex if format_type is not recognized
            formats_to_export = ['bibtex']

        for fmt in formats_to_export:
            if fmt == 'json':
                filename = f"{filename_base}.json"
                self.export_results_to_json(results, filename)
            elif fmt == 'bibtex':
                filename = f"{filename_base}.bib"
                self.export_results_to_bibtex(results, filename)